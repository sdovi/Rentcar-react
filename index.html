<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        /* Общие стили и сброс */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #212124; /* Темный фон как на скриншоте */
            color: #e8eaed; /* Светлый цвет текста */
        }

        /* Контейнер для всего приложения */
        .scanner-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Видео с камеры на весь фон */
        #qr-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        /* Оверлей для затемнения всего, кроме окна сканера */
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        /* Верхняя панель */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            z-index: 3;
        }

        .back-arrow {
            font-size: 28px;
            font-weight: bold;
            color: #e8eaed;
            text-decoration: none;
            margin-right: 15px;
            transform: scaleY(1.3); /* Делаем стрелку чуть выше */
        }

        .header-title {
            flex-grow: 1;
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            padding-right: 45px; /* Компенсируем место от стрелки */
        }

        /* Текст с инструкцией */
        .instruction-text {
            position: relative;
            z-index: 3;
            margin-top: 80px; /* Отступ от верха */
            font-size: 15px;
            color: #bdc1c6;
            width: 80%;
            max-width: 300px;
            text-align: center;
            line-height: 1.4;
        }

        /* Рамка сканера */
        .viewfinder {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 240px;
            height: 240px;
            transform: translate(-50%, -50%);
            /* "Вырезаем" окно с помощью тени */
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        /* Уголки рамки */
        .viewfinder::before,
        .viewfinder::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border-color: #ff453a; /* Оранжево-красный цвет */
            border-style: solid;
        }
        .viewfinder::before {
            top: -5px;
            left: -5px;
            border-width: 5px 0 0 5px;
        }
        .viewfinder::after {
            top: -5px;
            right: -5px;
            border-width: 5px 5px 0 0;
        }

        .viewfinder .corner-bottom-left,
        .viewfinder .corner-bottom-right {
            position: absolute;
            width: 40px;
            height: 40px;
            border-color: #ff453a;
            border-style: solid;
        }

        .corner-bottom-left {
            bottom: -5px;
            left: -5px;
            border-width: 0 0 5px 5px;
        }
        .corner-bottom-right {
            bottom: -5px;
            right: -5px;
            border-width: 0 5px 5px 0;
        }
        
        /* Сообщение о результате */
        #output {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #333;
            color: white;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            z-index: 10;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        #output.visible {
             transform: translateY(0);
        }
        #output-data {
            font-weight: bold;
            word-wrap: break-word;
        }
    </style>
</head>
<body>

    <div class="scanner-container">
        <video id="qr-video" playsinline></video>

        <div class="scanner-overlay">
            <div class="header">
                <a href="#" class="back-arrow" onclick="history.back(); return false;">‹</a>
                <div class="header-title">Сканировать QR-код</div>
            </div>

            <p class="instruction-text">
                Чтобы авторизоваться на десктопе, откройте в браузере страницу авторизации LAVA
            </p>
            
            <div class="viewfinder">
                <div class="corner-bottom-left"></div>
                <div class="corner-bottom-right"></div>
            </div>
        </div>
    </div>
    
    <canvas id="qr-canvas" style="display: none;"></canvas>
    
    <div id="output">
        <p>Найден QR-код:</p>
        <div id="output-data"></div>
    </div>

   <script>
    const video = document.getElementById('qr-video');
    const canvasElement = document.getElementById('qr-canvas');
    const canvas = canvasElement.getContext('2d');
    const outputContainer = document.getElementById('output');
    const outputData = document.getElementById('output-data');
    const viewfinder = document.querySelector('.viewfinder'); // Находим рамку
    let scanning = true;

    // Запрашиваем доступ к камере
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function(stream) {
            video.srcObject = stream;
            video.setAttribute("playsinline", true); // Необходимо для iOS
            video.play();
            requestAnimationFrame(tick); // Начинаем сканирование
        })
        .catch(function(err) {
            console.error("ERROR: " + err);
            alert("Не удалось получить доступ к камере. Пожалуйста, разрешите доступ в настройках браузера.");
        });

    function tick() {
        if (!scanning) return;

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            // --- НАЧАЛО ИЗМЕНЕНИЙ ---

            // 1. Получаем реальные размеры и положение рамки на экране
            const viewfinderRect = viewfinder.getBoundingClientRect();
            
            // 2. Рассчитываем, какую часть кадра с камеры нужно вырезать.
            //    Это нужно, т.к. разрешение видео и размер экрана могут не совпадать.
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;

            // Коэффициенты масштабирования
            const scaleX = videoWidth / screenWidth;
            const scaleY = videoHeight / screenHeight;

            // Вычисляем координаты для "вырезания" (crop)
            const sx = viewfinderRect.left * scaleX;
            const sy = viewfinderRect.top * scaleY;
            const sWidth = viewfinderRect.width * scaleX;
            const sHeight = viewfinderRect.height * scaleY;
            
            // 3. Устанавливаем размер canvas равным размеру вырезаемой области
            canvasElement.width = sWidth;
            canvasElement.height = sHeight;

            // 4. Рисуем на canvas только нужную часть кадра с камеры
            canvas.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);
            
            // 5. Получаем данные изображения с canvas (теперь там только область из рамки)
            const imageData = canvas.getImageData(0, 0, sWidth, sHeight);
            
            // --- КОНЕЦ ИЗМЕНЕНИЙ ---
            
            // Пытаемся распознать QR-код в этой области
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                // Если код найден
                scanning = false; // Останавливаем цикл сканирования
                video.srcObject.getTracks().forEach(track => track.stop()); // Выключаем камеру
                
                // Показываем результат
                outputData.innerText = code.data;
                outputContainer.classList.add('visible');
                
                // Вибрация для обратной связи
                if ('vibrate' in navigator) {
                    navigator.vibrate(200);
                }
            }
        }
        
        // Продолжаем сканировать следующий кадр, если код не найден
        if (scanning) {
            requestAnimationFrame(tick);
        }
    }
</script>
</body>
</html>